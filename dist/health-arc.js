(function(){"use strict";const A=window.PIXI;function C(e,t,n){return Math.max(t,Math.min(n,e))}function b(e,t,n){return Math.round(e+(t-e)*n)}function J(){const e=window;return e._hpUncertaintyMap||(e._hpUncertaintyMap=new Map),e._hpUncertaintyMap}function w(e){var O,N,X,F,R,$,z,B,W,j,q;const t=e.actor,n=(N=(O=t==null?void 0:t.system)==null?void 0:O.attributes)==null?void 0:N.hp;if(!n)return;const c=Number(n.value)||0,s=Number(n.max)||1,i=Number(n.temp)||0,a=C(c/s,0,1),d=i>0&&s>0?C(i/s,0,1):0,L=4,_=Math.PI/4,v=0,T=v-_,G=((X=e.texture)==null?void 0:X.width)??e.w,Q=e.w/G,M=L/Q,S=G/2+M/2+40,x=a>=.1?(1-a)/.9:1,V=b(70,106,x)<<16|b(92,26,x)<<8|b(26,26,x);let r=e._healthArc,o,l,p;r&&((F=r.children)==null?void 0:F.length)===3?([o,l,p]=r.children,o.clear(),l.clear(),p.clear()):(r&&H(e,!1),r=new A.Container,r.zIndex=100,r.position.set(0,0),o=new A.Graphics,l=new A.Graphics,p=new A.Graphics,r.addChild(o,l,p),(R=e.mesh)!=null&&R.addChild?e.mesh.addChild(r):e.addChild&&e.addChild(r),e._healthArc=r),r.alpha=e.combatant||t!=null&&t.combatant||e.controlled||e.hover?1:.25,o.lineStyle(M,2236962,.4),o.arc(0,0,S,v,T,!0);let E=a;const m=game==null?void 0:game.user,Y=m==null?void 0:m.isGM,Z=e.isOwner||(t==null?void 0:t.isOwner);if(!Y&&!Z&&m){const g=`${e.id}-${m.id}`,f=J();let h=f.get(g),u=10;((B=(z=($=t==null?void 0:t.system)==null?void 0:$.skills)==null?void 0:z.prc)==null?void 0:B.passive)!=null?u=+t.system.skills.prc.passive||10:((q=(j=(W=t==null?void 0:t.system)==null?void 0:W.attributes)==null?void 0:j.perception)==null?void 0:q.passive)!=null&&(u=+t.system.attributes.perception.passive||10),u=C(u,1,30);let D=Math.max(0,.3-(u-10)*.02);if(!h||h.actual!==c){const ee=Math.random();let y=a+(ee*2-1)*D;c>0&&(y=Math.max(y,.01)),y=Math.max(y,0),h={actual:c,percent:y},f.set(g,h)}E=h.percent}l.lineStyle(M,V,1);const k=v-_*E;if(l.arc(0,0,S,v,k,!0),d>0){p.lineStyle(M,2771562,1);const g=_*d,f=T,h=f-g;p.arc(0,0,S,f,h,!0)}}function H(e,t=!0){var n;e._healthArc&&((n=e.mesh)!=null&&n.removeChild?e.mesh.removeChild(e._healthArc):e.removeChild&&e.removeChild(e._healthArc),e._healthArc.destroy(),delete e._healthArc)}const P=window.Hooks;function U(){return window.canvas}function K(e){var c;const t=U(),n=(c=t==null?void 0:t.tokens)==null?void 0:c.placeables;if(n)for(let s=0,i=n.length;s<i;s++)e(n[s])}function I(e,t){if(!(!e||typeof t!="string"))return t.split(".").reduce((n,c)=>n?n[c]:void 0,e)}P.on("canvasReady",()=>{K(w)}),P.on("updateToken",(e,t,n,c)=>{var a,d;if(!(I(n,"actorData.system.attributes.hp")||I(n,"system.attributes.hp")||(n==null?void 0:n.bar1)||(n==null?void 0:n.bar2)))return;const i=c||((d=(a=U())==null?void 0:a.tokens)==null?void 0:d.get(t._id));i&&(H(i),w(i))}),P.on("drawToken",e=>{w(e)}),P.on("refreshToken",e=>{H(e),w(e)})})();
